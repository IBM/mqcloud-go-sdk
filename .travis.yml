######################################## {COPYRIGHT-TOP} ###
# Licensed Materials - Property of IBM
#
# 5900-A0Y, 5737-H57
#
# (C) Copyright IBM Corp. 2021, 2023 All Rights Reserved.
#
# US Government Users Restricted Rights - Use, duplication or
# disclosure restricted by GSA ADP Schedule Contract with
# IBM Corp.
######################################## {COPYRIGHT-END} ###
# DO NOT EDIT: Generated by https://github.ibm.com/mqoc/repo-bootstrap
sudo: required
language: go
dist: focal

env:
  global:
    - IS_LIBRARY=true
    - IS_TOOL=false
    - REPOSITORY=mqcloud-go-sdk

git:
  depth: false

services:
  - docker

go:
  - 1.20.x

before_install:
  - |
    if [ -z "$GITHUB_TOKEN" ]; then
      echo 'Error: missing $GITHUB_TOKEN' >&2
      exit 1
    fi
    printf "machine github.ibm.com\n  login $GITHUB_TOKEN\n" > ~/.netrc
  - |
    if [ -z "$ARTIFACTORY_TOKEN" ]; then
      echo 'Error: missing $ARTIFACTORY_TOKEN' >&2
      exit 1
    fi
    if ! command -v jf &> /dev/null; then
      echo "jf not found, installing..."
      curl -fL https://install-cli.jfrog.io | sh
    fi

install:
  - |
    mkdir -p $GOPATH/src/github.ibm.com/mqoc && \
    git clone git@github.ibm.com:mqoc/cluster-bootstrap.git "$GOPATH/src/github.ibm.com/mqoc/cluster-bootstrap" && \
    cd "$GOPATH/src/github.ibm.com/mqoc/cluster-bootstrap" && \
    ./lifecycle/pull-from-artifactory.sh --file cluster-bootstrap
stages:
  - name: pipeline
  - name: deployment
    if: (type = pull_request OR branch IN (main, master)) AND NOT (env(IS_TOOL) OR env(IS_LIBRARY))
  - name: success
    if: (type = pull_request OR branch IN (main, master)) AND NOT (env(IS_TOOL) OR env(IS_LIBRARY))
jobs:
  allow_failures:
    - env: CLUSTER_STYLE=OCP
      if: env(OCP_PASS_BUILD) = "true"
  include:
  - stage: pipeline
    name: pipeline
    script:
      - |
        cd $GOPATH/src/github.ibm.com/mqoc/$REPOSITORY && \
        make && \
        make test && \
        $GOPATH/src/github.ibm.com/mqoc/cluster-bootstrap/lifecycle/pipeline.sh
  - stage: deployment
    name: openshift
    env:
      - CLUSTER_STYLE=OCP
    script:
      - |
        cd $GOPATH/src/github.ibm.com/mqoc/$REPOSITORY && \
        $GOPATH/src/github.ibm.com/mqoc/cluster-bootstrap/lifecycle/deployment-test.sh
  - stage: deployment
    name: kubernetes
    env:
      - CLUSTER_STYLE=IBMCLOUD
    script:
      - |
        cd $GOPATH/src/github.ibm.com/mqoc/$REPOSITORY && \
        $GOPATH/src/github.ibm.com/mqoc/cluster-bootstrap/lifecycle/deployment-test.sh
  - stage: success
    name: success
    script:
      - |
        cd $GOPATH/src/github.ibm.com/mqoc/$REPOSITORY && \
        $GOPATH/src/github.ibm.com/mqoc/cluster-bootstrap/lifecycle/build-success.sh

deploy:
  provider: script
  script: make tag-release
  on:
    branch: master

cache:
  directories:
    - $HOME/.cache/go-build
    - $HOME/gopath/pkg/dep
    - $HOME/gopath/pkg/mod

after_failure:
  - $GOPATH/src/github.ibm.com/mqoc/cluster-bootstrap/lifecycle/slack-notify.sh
